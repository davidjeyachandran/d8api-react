<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drupal ReactJS</title>
  <link href="build/bootstrap.min.css" rel="stylesheet">
  <script src="build/jquery-2.2.4.min.js"></script>
  <script src="build/react.min.js"></script>
  <script src="build/react-dom.min.js"></script> 
  <script src="build/btib.min.js"></script>
  <script src="build/axios.min.js"></script>
   <style>
  body {
    background-color: #eee;
  }

  * {
    /*border: 1px solid orange;*/
  }
  .post {
    margin: 10px 0;
    padding: 10px 0 10px 0;
    background-color: white;
  }

  .photo {
    float: left;
    padding: 0 10px 10px 0;
  }

  .post-details h3 {
    font-size: 1.5em;
    padding-bottom: 0px;
    margin: 0px;
  }

  .post-text {
    clear: both;
  }

  .date {
    color: #888;
    font-size: 0.9em;
  }

  </style>
</head>
<body>
  <h1>Drupal ReactJS</h1>
  <div id="app"></div>

  <script type="text/es2015">

  class PostBox extends React.Component {

    constructor(props) {
      super(props);
      this.handleClick = this.handleClick.bind(this);
    }

    handleClick() {
      console.log('Click');
      var postValue = document.getElementById('post_input').value;
      this.props.submitHandler(postValue);
    }

    render() {
      return (
        <div>
          <textarea
          id="post_input"
          className="post-input form-control" placeholder="Escribe aqui tu publicaciÃ³n">
          </textarea>
          <button id="post_button" onClick={this.handleClick}>Publicar</button>
        </div>
        );
    }
  }
    function Post( {userPicURL, author, created, title}) {
      return (
          <div className="post row col-md-12">
            <div className="col-md-6">
              <img className="photo" src={userPicURL} />
              <div className="post-details">
                <h3>{author}</h3>
                <span className="date">{created}</span>
              </div>
            </div>
            <div className="post-text col-md-12">
              {title}
            </div>
          </div>
        );
    }

    function Posts({data, siteDomain}) {
      var postHTML = data.map(function(item) {
        return (
          <Post userPicURL={siteDomain + item.user_pic} author={item.author} created={item.created} title={item.title} />
          );
      });
      return (<div>{postHTML}</div>);
    }

  class PostContainer extends React.Component {

    constructor(props) {
      super(props);
      this.state = {data:[]};
      this.siteURL = this.props.siteDomain + 'search3/';
    }

    componentWillMount() {
      const endpointFeed = this.siteURL + 'api/articles?_format=json';
      this.loadFeed(endpointFeed);
    }

    loadFeed(endpointFeed) {
      $.ajax({
        url: endpointFeed,
        dataType: 'json',
        cache: true,
        headers: {
            "Authorization": this.props.headers
        },
        success: function(data) {
          this.setState({data: data});
          console.log(data);
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(endpointFeed, status, err.toString());
        }.bind(this)
      });
    }

    render() {
      return <Posts data={this.state.data} siteDomain={this.props.siteDomain}/>;
    }
  }


  class App extends React.Component {

    constructor(props) {
      super(props);
      this.state = {
        isLoggedIn: false,
        csrfToken: '',
        headers: '',
      };
      this.siteURL = this.props.siteDomain + 'search3/';
      this.login = this.login.bind(this);
      this.submitHandler = this.submitHandler.bind(this);
      // this.createNode = this.createNode;
    }

    componentDidMount() {
      const inputUsername = 'David';
      const inputPassword = 'password';
      this.setState({headers: 'Basic ' + btoa('David' + ":" + 'password')});
      this.login(inputUsername, inputPassword);
    }

    login(inputUsername, inputPassword) {
      if (inputUsername != '' && inputPassword != '') {
              $.ajax({
                  url: this.siteURL + 'user/login?_format=json',
                  type: 'POST',
                  dataType: 'json',
                  data: JSON.stringify({name: inputUsername, pass: inputPassword})
              }).done(function(response) {
                  if (response.current_user) {
                      this.setState({isLoggedIn: true});
                      console.log('The user is logged!');
                      console.log(response);
                      this.setState({csrfToken: response.csrf_token});
                  }
              }.bind(this)).fail(function(jqXHR, textStatus) {
                  console.log('Failed Login');
              });
      }
    }

    submitHandler(title) {
      console.log('yo - submitHandler Parent' + this.state.csrfToken);
      this.postNode(this.state.csrfToken, this.createNode(title));
      // this.setState({data: newData});
    }

    createNode(title) {
      return {
        _links: {
          type: {
            href: this.siteURL + 'rest/type/node/article'
          }
        },
        type: {
          target_id: 'article'
        },
        title: {
          value: title
        },
        body: {
          value: 'Yo yo - Example node title2'
        }
      };
    }

    postNode(csrfToken, node) {
      jQuery.ajax({
        url: this.siteURL + 'entity/node?_format=hal_json',
        method: 'POST',
        // headers: {
        //   'Content-Type': 'application/hal+json',
        //   'X-CSRF-Token': csrfToken
        // },
        headers: {
            'Content-Type': 'application/hal+json',
            "Authorization": this.state.headers
        },
        data: JSON.stringify(node),
        success: function (node) {
          console.log(node);
          jQuery('#app').html('Node created with nid=' + node.nid[0].value);
        }
      });
    }

    render() {
          if (this.state.isLoggedIn && this.state.csrfToken.length > 0){
            return (<div>
              <PostBox submitHandler={this.submitHandler}/>
              <PostContainer
                siteDomain={this.props.siteDomain}
                csrfToken={this.state.csrfToken}
                headers={this.state.headers} />
              </div>);
          }
          else {
            return(<div>Not Logged in</div>);
          }
    }
  }

  ReactDOM.render(<App siteDomain="http://servinginperu.com/" />,
    document.getElementById('app'));

  // ReactDOM.render(<App siteDomain="http://servinginperu.com/" />, document.getElementById('app'));


  </script>
</body>
</html>
